.\" Automatically generated by Pandoc 2.17.1.1
.\"
.\" Define V font for inline verbatim, using C font in formats
.\" that render this, and otherwise B font.
.ie "\f[CB]x\f[]"x" \{\
. ftr V B
. ftr VI BI
. ftr VB B
. ftr VBI BI
.\}
.el \{\
. ftr V CR
. ftr VI CI
. ftr VB CB
. ftr VBI CBI
.\}
.TH "SCC-HYPERVISOR-COLLECTOR" "1" "June 2022" "" "SCC Hypervisor Collector"
.hy
.SH NAME
.PP
\f[B]scc-hypervisor-collector\f[R] - Collect & Upload Hypervisor details
to SUSE Customer Center
.SH SYNOPSIS
.PP
\f[B]scc-hypervisor-collector [<optional>...]\f[R]
.SH DESCRIPTION
.PP
The \f[B]scc-hypervisor-collector(1)\f[R] collects details relevant to
subscription compliance tracking from customer hypervisor solutions and
uploads them to the SUSE Customer Center (SCC), using provided customer
credentials.
.SH COLLECTED DETAILS
.PP
For each hypervisor node that is managed by the specified hypervisors,
the following details are collected:
.TP
\f[B]Hypervisor Node Name\f[R]
The name assigned to the hypervisor node
.TP
\f[B]Hypervisor Node ID\f[R]
The id assigned to the hypervisor node
.TP
\f[B]Hypervisor Type\f[R]
The id assigned to the hypervisor node
.TP
\f[B]RAM\f[R]
Total system memory
.TP
\f[B]CPU Architecture\f[R]
The type of CPU, e.g.
\f[B]x86_64\f[R], \f[B]aarch64\f[R]
.TP
\f[B]CPU Topology\f[R]
The number of sockets, cores and threads
.TP
\f[B]Hosted VMs\f[R]
List of hosted VM with identification and state info.
.PP
For each hosted VM the following details are collected:
.TP
\f[B]Name\f[R]
The hypervisor configuration name for to the VM
.TP
\f[B]UUID\f[R]
The UUID associated with the VM if has been registered with the SCC.
In some cases (VMWare, see below) it may be a mangled form of the
origial UUID assigned by the hypervisor node.
.TP
\f[B]VMWare UUID\f[R] (VMWare Hypervisors only)
The UUID that VMWare assigned to the VM.
Depending on the VMWare hypervisor host software version, the VM BIOS
version used, and the Linux distribution/release being run, in some
cases the system UUID reported within the running instance may reverse
the byte order within each of the first 3 elements of the UUID.
.TP
\f[B]VM State\f[R]
The state of the VM, i.e.
running or stopped/shutoff.
.SS EXAMPLES OF COLLECTED DETAILS
.PP
The following examples are YAML representations of the details that are
collected from a QEMU/KVM Libvirt host and a VMWare vCenter:
.IP
.nf
\f[C]
[libvirt1]
kvmhost1.example.com:
  capabilities:
    cpu_topology:
      arch: x86_64
      cores: 8
      sockets: 2
      threads: 1
    ram_mb: 128781
    type: QEMU
  id: af78bfa8-67df-4d84-8d32-e40eb2404ac1
  name: sle15-dev
  vms:
    some-workload-vm-1:
      uuid: c44bae94-bab0-44f5-8603-0d770344facc
      vmState: running
    some-workload-vm-2:
      uuid: f5319c28-377f-46fe-acee-5509a356f652
      vmState: running
    some-workload-vm-3:
      uuid: 51b62ad3-effd-45db-b508-1ac47a528b93
      vmState: running
    some-workload-vm-4:
      uuid: cf46f104-5806-4ddd-9e99-32d167d063a3
      vmState: running

[vcenter1]
esx1.dc1-vcenter.example.com:
  capabilities:
    cpu_topology:
      arch: x86_64
      cores: 12
      sockets: 2
      threads: 24
    ram_mb: 253917
    type: vmware
  id: \[aq]\[aq]\[aq]vim.HostSystem:host-15\[aq]\[aq]\[aq]
  name: esx1.dc1-vcenter.example.com
  vms:
    some-workload-vm-1:
      uuid: 422270db-f382-4955-8cbd-75736a64089b
      vmState: running
      vmware_uuid: 422270db-f382-4955-8cbd-75736a64089b
    another-workload-vm-2:
      uuid: 4222dec1-6226-4f44-95e4-05156ea0f4b5
      vmState: running
      vmware_uuid: 4222dec1-6226-4f44-95e4-05156ea0f4b5
esx2.dc1-vcenter.example.com:
  capabilities:
    cpu_topology:
      arch: x86_64
      cores: 12
      sockets: 2
      threads: 24
    ram_mb: 262109
    type: vmware
  id: \[aq]\[aq]\[aq]vim.HostSystem:host-27\[aq]\[aq]\[aq]
  name: esx2.dc1-vcenter.example.com
  vms:
    another-workload-vm-1:
      uuid: 42225602-4139-44fb-b111-e5b8df028b1c
      vmState: running
      vmware_uuid: 42225602-4139-44fb-b111-e5b8df028b1c
    linux-workload-vm-3:
      uuid: 5dec2242-969f-1dee-8137-209da409ec2b
      vmState: running
      vmware_uuid: 4222ec5d-9f96-ee1d-8137-209da409ec2b
    linux-workload-vm-1:
      uuid: 564d2049-beb3-8f38-bfea-488d2a4186cd
      vmState: running
      vmware_uuid: 564d2049-beb3-8f38-bfea-488d2a4186cd
    linux-workload-vm-2:
      uuid: 7e0f2242-f1c3-dd4a-b902-18f602165074
      vmState: running
      vmware_uuid: 42220f7e-c3f1-4add-b902-18f602165074
\f[R]
.fi
.SH OPTIONS
.TP
\f[B]-h\f[R], \f[B]--help\f[R]
Provides basic details about the available command line options.
.TP
\f[B]-V\f[R], \f[B]--version\f[R]
Reports the version of \f[B]scc-hypervisor-collector\f[R].
.TP
\f[B]-q\f[R], \f[B]--quiet\f[R]
Runs in quiet mode, only reporting errors.
.TP
\f[B]-v\f[R], \f[B]--verbose\f[R]
Runs in verbose mode, reporting additional details.
.TP
\f[B]-c\f[R], \f[B]--config <CONFIG_FILE>\f[R]
Specifies a file containing YAML configuration settings.
If both \f[B]--config\f[R] and \f[B]-config-dir\f[R] options are
specified, the specified \f[B]--config\f[R] file contents will be merged
over the settings loaded from the \f[B]-config-dir\f[R] directory,
superceding any existing settings.
.TP
\f[B]--config-dir\f[R], \f[B]--config_dir <CONFIG_DIR>\f[R]
Specifies a directory containing one of more YAML configuration files,
with \f[B].yaml\f[R] or \f[B].yml\f[R] suffixes that will be merged
together, in lexical sort order, to construct the configuration
settings.
Note that sub-directories will not be traversed.
Defaults to \f[B]\[ti]/.config/scc-hypervisor-collector\f[R].
.TP
\f[B]-C\f[R], \f[B]--check\f[R]
Checks the specified configuration settings for correctness, reporting
any issues found.
.TP
\f[B]-S\f[R], \f[B]--scc-credentials-check\f[R]
Validates that the supplied SCC credentials can be used to connect to
the SCC.
.TP
\f[B]-L\f[R], \f[B]--logfile <LOG_FILE>\f[R]
Specifies the path to the log file in which to write log messages.
Defaults to \f[B]\[ti]/scc-hypervisor-collector.log\f[R].
.TP
\f[B]-u\f[R], \f[B]--upload\f[R]
Specifies whether to upload the collected results to the SCC.
.TP
\f[B]-r\f[R], \f[B]--retry_on_rate_limit\f[R]
Specifies whether to retry uploading to SCC when rate limit is hit.
If the \f[B]scc-hypervisor-collector\f[R] is being run frequently, e.g.
daily, then it may be preferable to just wait until the next run, rather
than delaying and retrying again after the SCC rate limit response\[aq]s
retry delay.
.TP
\f[B]-i\f[R], \f[B]--input <INPUT_FILE>\f[R]
Specifies the path to a YAML file containing previously collected
results.
If this option is specified then any hypervisor backends configuration
will be ignored and the contents of this file, so long as they conform
to the expected results layout, will be used as the collected results to
be uploaded.
This option cannot be used in conjunction with the
\f[B]-o\f[R]/\f[B]--output\f[R] option.
.TP
\f[B]-o\f[R], \f[B]--output <OUTPUT_FILE>\f[R]
Specifies the path to a file to which the YAML formatted results of the
details collected from the specified hypervisor backends will be
written.
Any existing file contents will be lost, and the file mode settings will
be modified so that only ownwer can access it.
This option also disables uploading results to the SCC, and cannot be
used in conjunction with the \f[B]-i\f[R]/\f[B]--input\f[R] option.
.SH SECURITY CONSIDERATIONS
.PP
The \f[B]scc-hypervisor-collector(1)\f[R] is intended to be run from a
restricted service account with no special privileges, and will exit
immediately if it detects that it is running with superuser privileges.
.SS HYPERVISOR ACCESS CREDENTIALS
.PP
Any hypervisor access credentials that are provided for use with the
\f[B]scc-hypervisor-collector(1)\f[R] should have minimal privileges
sufficent to allow retrieving the required details about the hypervisor
nodes and then VMs running on them.
.SS CONFIGURATION SETTINGS & LOG FILE PERMISSIONS
.PP
As the \f[B]scc-hypervisor-collector(5)\f[R] configuration settings will
contain sensitive information such as passwords, the command requires
that all specified configuration files and directories must be owned by
the non-root user that is running the command, with restrictive
permissions allowing only that user to access those files.
.PP
Similarly, while every effort has been taken to ensure that no sensitive
data is being written to the log files, to limit potential exposure of
such information the log files must also be owned by, and only
accessible by, the user that is running the
\f[B]scc-hypervisor-collector(5)\f[R] command.
.SS TLS/SSL CERTIFICATES
.PP
The \f[B]virtual-host-gatherer(1)\f[R] framework only supports certs
that are registered with the system certificate stores.
See \f[B]update-ca-certificates(8)\f[R] for details.
.SS SSH KEYS
.PP
For any \f[B]Libvirt\f[R] hypervisors that are specified with a
\f[B]qemu+ssh\f[R] type URI, appropriate SSH keys that support
passwordless SSH access to the target hypervisor node, must be available
in the \f[B]\[ti]/.ssh/\f[R] directory.
.PP
See \f[B]ssh-keygen(1)\f[R] for more details on how to generate
appropriate SSH keys if needed, and \f[B]ssh(1)\f[R] for the appropriate
permissions for the \f[B]\[ti]/.ssh/\f[R] directory and any keys stored
there.
.SS SEPARATE COLLECTION AND UPLOAD RUNS
.PP
Leveraging the \f[B]-o\f[R]/\f[B]--output\f[R] and
\f[B]-i\f[R]/\f[B]--input\f[R] options, it will be possible to run the
details collection stage only, saving the collected results to a file,
which can then be uploaded to the SCC in a separate run, potentially on
a different system.
.PP
This allows for customer deployment scenarioes where the system that has
access to be able to collect details from the hypervisor backends may
not have internet access to be able to upload the collected details to
the SCC; the details collection can phase can be run on an internal
system with the necessary access, with the saved collection results then
being transferred to another system with internet access that can run
the upload phase.
.SS Reviewing and sanitizing the collected results
.PP
This separation of the collection and upload phases also allows the
collected results data to be reviewed and potentially sanitised, e.g.
hostnames and VM names can be changed.
.PP
However, certain values, such as the VM UUIDs and Libvirt host system
properties and identifiers should not modified as these values are used
to cross reference collection details with any associated subscriptions
in the SCC.
.SH CONFIGURATION SETTINGS
.PP
Configuration settings are specified in YAML format and must contain:
.TP
\f[B]backends\f[R]
a list of hypervisor backends from which to retrieve relevant details
.TP
\f[B]credentials\f[R]
a collection of credentials that will be used to upload the collected
details to the SUSE Customer Center.
.PP
See \f[B]scc-hypervisor-collector(5)\f[R] for details about the possible
configuration settings.
.SS CONFIGURATION MANAGEMENT
.PP
The configuration settings, which must be in YAML format, can be
specified as:
.IP \[bu] 2
a single config file via the \f[B]--config\f[R] option.
.IP \[bu] 2
a directory containing a set of YAML files (with \f[B].yaml\f[R] or
\f[B].yml\f[R] suffixes) via the \f[B]-config-dir\f[R] option.
.PP
If a configuration directory is specified then any YAML files found
under that directory, not traversing sub-directories, with
\f[B].yaml\f[R] or \f[B].yml\f[R] suffixes, will be processed in lexical
sort order, merging their contents together.
.PP
If a configuration file was specified, it\[aq]s contents will be
processed last and merged over any existing configuration settings.
.PP
This scheme allows for configuration settings to be split up into
multiple files, e.g.
credentials can be specified in one file, and the hypervisor backends in
one or more files.
Additionally specific config settings can be overriden by an explicitly
specified config file.
.PP
When splitting the hypervisor backend details among multiple files, the
\f[B]backends\f[R] lists in each file will be merged together to form a
single combined list; exact duplicates will be ignored but partial
duplicates will result in errors.
.SS ACCESS AND OWNERSHIP
.PP
For security reasons only the non-root user that is running the
\f[B]scc-hypervisor-collector\f[R] command should be able to access the
specified configuration files.
.SS CONFIGURATION VALIDATION
.PP
The \f[B]--check\f[R] option can be utilised to check if the specified
configuration settings are valid, or will report any errors that it
detected.
.SS SUPPORTED HYPERVISORS
.PP
The following hypervisor types are supported:
.IP \[bu] 2
VMWare vCenter (type \f[B]VMware\f[R])
.IP \[bu] 2
Libvirt (type \f[B]Libvirt\f[R])
.PP
Each hypervisor type has specific configuration settings that must be
provided to permit the relevant details to be retrieved; these settings
are documented in \f[B]scc-hypervisor-collector(5)\f[R].
.SH EXIT CODES
.PP
\f[B]scc-hypervisor-collector\f[R] sets the following exit codes:
.TP
\f[B]0\f[R]
Run completed successfully, or configuration settings are valid if check
mode (\f[B]--check\f[R]) was specified.
.TP
\f[B]1\f[R]
An error occurred.
.SH IMPLEMENTATION
.PP
\f[B]scc-hypervisor-collector(1)\f[R] is implemented in Python.
It communicates with the SUSE Customer Center via a RESTful JSON API
over HTTP using TLS encryption.
.SS HYPERVISOR DETAILS RETRIEVAL
.PP
The \f[B]gatherer\f[R] Python module provided by the
\f[B]virtual-host-gatherer(1)\f[R] command is used to retrieve the
details from the configured hypervisors.
.SH ENVIRONMENT
.PP
\f[B]scc-hypervisor-collector(1)\f[R] respects the HTTP_PROXY
environment variable.
See https://www.suse.com/support/kb/doc/?id=000017441 for more details
on how to manually configure proxy usage.
.SH FILES AND DIRECTORIES
.TP
\f[B]\[ti]/.config/scc-hypervisor-collector/\f[R]
Default configuration directory containing YAML configuration files,
merged together in lexical sort order.
Directory and files must be owned by, and only accessible by, the user
running the \f[B]scc-hypervisor-collector(5)\f[R] command.
.TP
\f[B]\[ti]/scc-hypervisor-collector.log\f[R]
Default log file which will be automatically rotated and compressed if
it gets too large.
Log files must be owned by, and only accessible by, the user running the
\f[B]scc-hypervisor-collector(5)\f[R] command.
Will be created with appropriate permissions if no log file exists.
.TP
\f[B]\[ti]/.ssh/\f[R] (optional)
Directory holding any SSH keys (\f[B]ssh-keygen\f[R]) needed to access
\f[B]Libvirt\f[R] with \f[B]qemu+ssh\f[R] URIs.
.SH AUTHORS
.PP
Originally developed by Fergal Mc Carthy (fmccarthy\[at]suse.com) and
Meera Belur (mbelur\[at]suse.com) for the SCC at SUSE LLC
(scc-feedback\[at]suse.de)
.SH LINKS
.PP
SUSE Customer Center: https://scc.suse.com
.PP
scc-hypervisor-collector on GitHub:
https://github.com/SUSE/scc-hypervisor-collector
.PP
virtual-host-gatherer on GitHub:
https://github.com/uyuni-project/virtual-host-gatherer
.PP
YAML Specification: https://yaml.org/
.SH SEE ALSO
.PP
\f[B]scc-hypervisor-collector(5)\f[R],
\f[B]scc-hypervisor-collector.service(8)\f[R],
\f[B]scc-hypervisor-collector.timer(8)\f[R],
\f[B]virtual-host-gatherer(1)\f[R], \f[B]update-ca-certificates(8)\f[R],
\f[B]systemd(1)\f[R].
