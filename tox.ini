[tox]
minversion = 2.9.1
basepython = python3
skip_missing_interpreters = True
envlist =
    cli,
    check,
    {py36,py37,py38,py39,py310}-{cover,nocov},

[gh-actions]
python =
    3.6: py36
    3.7: py37
    3.8: py38
    3.9: py39
    3.10: py310

[testenv]
wheel = true
basepython =
    py36: {env:TOXPYTHON:python3.6}
    py37: {env:TOXPYTHON:python3.7}
    py38: {env:TOXPYTHON:python3.8}
    py39: {env:TOXPYTHON:python3.9}
    py310: {env:TOXPYTHON:python3.10}
    {cli,check}: {env:TOXPYTHON:python3}
description = Basic command test
setenv =
    PYTHONUNBUFFERED=yes
passenv =
    *
usedevelop =
    cover: true
    nocov: false
deps =
    -r requirements.txt
    pytest
    pytest[psutils]
    cover: pytest-cov
    testfixtures
commands =
    # TODO(fergal): Enable failure reporting once test coverage
    # is sufficient.
    {posargs:-pytest -vv \
    cover:                 --no-cov-on-fail \
    cover:                 --cov=src \
    cover:                 --cov-report=term-missing \
    }


[testenv:check]
description = Check code compliance (pep8/mypy/pylint)
deps =
    -r requirements.txt  # pylint requires dependencies to be installed
    check-manifest >= 0.42
    flake8
    mypy
    types-requests
    types-PyYaml
    pylint
skip_install = true
commands =
    check-manifest --ignore 'tox.ini,*requirements.txt,bin/**,tests/**'
    python setup.py check -m -s
    flake8 src
    mypy --disallow-untyped-defs \
         --check-untyped-defs \
         --ignore-missing-imports \
         --disable-error-code attr-defined \
         src
    # disable snake case (invalid-name) (C0103)
    pylint --disable=invalid-name src

[testenv:cli]
description = Run scc-hypervisor-collector --help
deps =
    -r requirements.txt
commands =
    scc-hypervisor-collector --help
    scc-hypervisor-collector --version
